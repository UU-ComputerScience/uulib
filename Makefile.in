# Simple makefile to build UUAG.
# Nothing fancy, just as simple as possible to get things done quickly.
#   --Alexey

help:
	@echo Build system for the UU libraries
	@echo Targets:
	@echo
	@echo build - builds uulib using cabal
	@echo install - install uulib using cabal
	@echo dist - Create source distributions
	@echo source_tarball - Generate a snapshot of the repository
	@echo cabal_dist - Generate a cabal distribution

MV        = @MV@
RM        = @RM@
RM_F      = $(RM) -f
CP        = @CP@
FIND      = @FIND@
MKDIR     = @MKDIR@
VERSION   = @VERSION@
PREFIX    = @prefix@


# Directories
SRC_DIR = src
NAME = uulib


#
# distribution (for the time being source only and unix)
#

DISTTYPE=src

ifeq ($(DISTTYPE),win32)
        TARCZVF    := zip -r
        TAREXT     := .zip
else
        TARCZVF    := tar cvzf
        TAREXT     := .tar.gz
endif

# the name is hard-coded

TODAY  := $(shell date '+%Y-%m-%d')
DLABEL := $(NAME)-$(TODAY)
VLABEL := $(NAME)-$(VERSION)
DTLABEL:= $(NAME)-$(TODAY)-$(DISTTYPE)
VTLABEL:= $(NAME)-$(VERSION)-$(DISTTYPE)

dist_makedirs:
	$(RM_F) -r $(DLABEL)
	$(RM_F) -r $(VLABEL)
	$(MKDIR) -p $(DLABEL)
	$(MKDIR) -p $(DLABEL)/test
	for dir in `$(FIND) $(SRC_DIR) -type d -not -path '*/.svn*'`; do $(MKDIR) -p $(DLABEL)/$${dir}; done

dist_copy: dist_makedirs $(SRC_HS_SEM) $(SRC_HS_SYN)
	$(CP) -p LICENSE-LGPL \
		 COPYRIGHT \
		 VERSION \
		 README \
		 Makefile.in \
		 configure \
		 configure.in \
		 uulib.cabal \
		 uulib.cabal.in \
		 Setup.hs \
		 $(DLABEL)
	$(CP) -p test/Main.hs $(DLABEL)/test/Main.hs
# populate sources
	for file in `$(FIND) $(SRC_DIR) -name '*.hs' -type f -not -path '*/.svn*'`; do $(CP) -p $${file} $(DLABEL)/$${file}; done

dist_pack: dist_copy
	$(TARCZVF) $(DTLABEL)$(TAREXT) $(DLABEL)
	$(MV) $(DLABEL) $(VLABEL)
	$(TARCZVF) $(VTLABEL)$(TAREXT) $(VLABEL)

dist: dist_info dist_pack

dist_info:
	@echo "* Generating distributions..."

source_tarball: source_tarball_info source_tarball_pack

source_tarball_pack: dist_copy
	$(MV) $(DLABEL) $(VLABEL)
	$(TARCZVF) $(VTLABEL)$(TAREXT) $(VLABEL)

source_tarball_info:
	@echo "* Generating a snapshot..."

build:
	ghc --make Setup.hs -o setup
	./setup configure --prefix=$(PREFIX)
	./setup build

install: build
	./setup install

cabal_dist:
	ghc --make Setup.hs -o setup
	./setup configure --prefix=$(PREFIX)
	./setup sdist
	mv dist/uulib-*.tar.gz .

check: build
	cd test; ghc -fglasgow-exts -fallow-undecidable-instances --make -i.:../src Main.hs -o testprog
	./test/testprog
